(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{38494:function(e,s,t){Promise.resolve().then(t.bind(t,76222))},76222:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return ChatView}});var n=t(57437),r=t(2265),a=t(33116),l=t(17933),o=t(31706),c=t(51809),i=t(33316),d=t(98809),u=t(43241),m=t(78583),h=t(21037);function MarkdownView(e){var s;let{data:t}=e;return(0,n.jsx)("div",{className:"   w-full chatbox prose dark:prose-invert text-primary rounded p-2 ",children:(0,n.jsx)(u.U,{remarkPlugins:[d.Z],components:{code(e){let{node:s,inline:t,className:r,children:a,...l}=e,o=/language-(\w+)/.exec(r||""),c=o?o[1]:"text";return!t&&o?(0,n.jsx)(h.Z,{...l,style:m.Z,language:c,className:"rounded",PreTag:"div",wrapLongLines:!0,children:String(a).replace(/\n$/,"")}):(0,n.jsx)("code",{...l,className:r,children:a})}},children:null==(s=(s=t).replace(/\n/g,"  \n"))?void 0:s.replace(/```markdown\s+([\s\S]*?)\s+```/g,(e,s)=>s)})})}function MessageList(e){let{messages:s,sessionLogs:t,onRetry:a,loading:d}=e,u=r.useRef(null);r.useEffect(()=>{scrollToBottom()},[s,t]);let scrollToBottom=()=>{var e;null===(e=u.current)||void 0===e||e.scroll({top:u.current.scrollHeight,behavior:"smooth"})},renderLogs=e=>{let s=t[e]||[];return s.map((s,t)=>{let r=t%2==0;return(0,n.jsxs)("div",{className:"text-sm border rounded p-2 mb-2 ".concat(r?"bg-primary":"bg-secondary"),children:[(0,n.jsxs)("div",{className:"flex justify-between items-center text-xs text-gray-500 mb-1",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-semibold",children:s.type}),s.source&&(0,n.jsxs)("span",{className:"text-accent ml-2",children:["[",s.source,"]"]})]}),(0,n.jsx)("div",{children:new Date(s.timestamp).toLocaleTimeString()})]}),(0,n.jsx)("div",{className:"mt-1",children:(0,n.jsx)(MarkdownView,{data:s.content})})]},"log-".concat(e,"-").concat(t))})};return(0,n.jsxs)("div",{ref:u,style:{height:"calc(100% - 100px)"},className:"flex overflow-auto flex-col rounded scroll pr-2",children:[(0,n.jsx)("div",{className:"flex-1   mt-4"}),(0,n.jsx)("div",{className:"ml-2",children:s.map((e,s)=>{let r="user"===e.sender;return(0,n.jsx)("div",{className:"align-right ".concat(r?"text-right":"mb-2 border-b pb-2"),children:(0,n.jsxs)("div",{className:"".concat(r?"":"w-full"," inline-flex gap-2"),children:[(0,n.jsx)("div",{children:!r&&(0,n.jsx)("span",{className:"inline-block text-accent bg-primary pb-2 ml-1",children:(0,n.jsx)(l.Z,{className:"inline-block h-6"})})}),(0,n.jsx)("div",{className:"inline-block ".concat(r?"":"w-full"," p-2 rounded"),children:r?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"".concat(r?"bg-accent text-white":"bg-light"," p-2 rounded"),children:e.text}),(0,n.jsxs)("span",{role:"button",onClick:()=>a(e.text),className:"mt-1 text-sm inline-block",children:[(0,n.jsx)(o.Z,{className:"h-4 w-4 mr-1 inline-block"}),"Retry"]})]}):(0,n.jsxs)(n.Fragment,{children:[e.finalResponse&&(0,n.jsx)("div",{className:"mb-4",children:(0,n.jsx)(MarkdownView,{data:e.finalResponse})}),e.sessionId&&t[e.sessionId]&&(0,n.jsx)(i.Z,{defaultActiveKey:"processing"===e.status?["1"]:[],size:"small",className:"text-xs mt-2",items:[{key:"1",label:(0,n.jsx)("div",{children:(0,n.jsx)("span",{className:"pr-2",children:"processing"===e.status?"Processing...":"View Processing Steps"})}),children:(0,n.jsx)("div",{children:renderLogs(e.sessionId)})}]})]})}),r&&(0,n.jsx)(c.Z,{className:"inline-block h-6"})]})},"message-".concat(s))})}),(0,n.jsx)("div",{className:"ml-2 h-6 mb-4 mt-2",children:d&&(0,n.jsxs)("div",{className:"inline-flex gap-2",children:[(0,n.jsx)("span",{className:"rounded-full bg-accent h-2 w-2 inline-block"}),(0,n.jsx)("span",{className:"animate-bounce rounded-full bg-accent h-3 w-3 inline-block"}),(0,n.jsx)("span",{className:"rounded-full bg-accent h-2 w-2 inline-block"})]})})]})}var p=t(55856),x=t(85290),g=t(10887);function ChatInput(e){let{onSubmit:s,loading:t,error:a}=e,l=r.useRef(null),[o,c]=r.useState(t);r.useEffect(()=>{!o||t||a||resetInput(),c(t)},[t,a,o]);let resetInput=()=>{l.current&&(l.current.value="")},handleSubmit=()=>{var e;if((null===(e=l.current)||void 0===e?void 0:e.value)&&!t){let e=l.current.value;s(e)}};return(0,n.jsxs)("div",{className:"mt-2 p-2 w-full",children:[(0,n.jsxs)("div",{className:"mt-2 rounded p-2 shadow-lg flex mb-1 ".concat(t?"opacity-50 pointer-events-none":""),children:[(0,n.jsx)("form",{className:"flex-1",onSubmit:e=>{e.preventDefault(),handleSubmit()},children:(0,n.jsx)("input",{id:"queryInput",name:"queryInput",onKeyDown:e=>{"Enter"===e.key&&handleSubmit()},ref:l,className:"w-full text-gray-600 rounded rounded-r-none border border-accent bg-white p-2",placeholder:"Type your message here...",disabled:t})}),(0,n.jsx)("div",{role:"button",onClick:handleSubmit,className:"bg-accent hover:brightness-75 transition duration-300 rounded pt-2 rounded-l-none px-5",children:t?(0,n.jsx)("div",{className:"inline-block",children:(0,n.jsx)(x.Z,{className:"relative -pb-2 text-white animate-spin inline-flex rounded-full h-6 w-6"})}):(0,n.jsx)("div",{className:"inline-block",children:(0,n.jsx)(p.Z,{className:"h-6 text-white inline-block"})})})]}),a&&!a.status&&(0,n.jsxs)("div",{className:"p-2 border rounded mt-4 text-orange-500 text-sm",children:[(0,n.jsx)(g.Z,{className:"h-5 text-orange-500 inline-block mr-2"}),a.message]})]})}function ChatView(e){let{initMessages:s,viewHeight:t="100%"}=e,l="http://localhost:8081/api",[o,c]=r.useState(!1),[i,d]=r.useState({status:!0,message:"All good"}),[u,m]=r.useState([]),[h,p]=r.useState(null),[x,g]=r.useState({}),[b,f]=r.useState({}),getBaseUrl=e=>{try{return e.replace(/(^\w+:|^)\/\//,"").replace("/api","").replace(/\/$/,"")}catch(e){throw console.error("Error processing server URL:",e),Error("Invalid server URL configuration")}};r.useEffect(()=>{m(s)},[s]),r.useEffect(()=>()=>{Object.values(b).forEach(e=>e.close())},[b]);let connectWebSocket=async e=>{let s=getBaseUrl(l),t="ws://".concat(s,"/api/ws/logs/").concat(e),n=new WebSocket(t);return n.onopen=()=>{f(s=>({...s,[e]:n}))},n.onmessage=s=>{let t=JSON.parse(s.data);g(s=>({...s,[e]:[...s[e]||[],t]})),"GroupChatPublishEvent"===t.type&&m(s=>s.map(s=>s.sessionId===e&&"bot"===s.sender?{...s,text:t.content}:s)),"TerminationEvent"===t.type&&(n.close(),f(s=>{let t={...s};return delete t[e],t}))},n.onclose=()=>{f(s=>{let t={...s};return delete t[e],t})},n.onerror=s=>{console.error("WebSocket error:",s),a.ZP.error("WebSocket connection error"),n.close(),f(s=>{let t={...s};return delete t[e],t})},n},createSession=async()=>{let e=await fetch("".concat(l,"/create_session"),{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw Error("Failed to create session");let s=await e.json();return s.session_id},chatHistory=e=>{let s="";return e.forEach(e=>{s+="".concat(e.sender,": ").concat(e.text,"\n")}),s},getLastMessage=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;for(let t=e.length-1;t>=0;t--){let n=e[t].content;if(n.length>s)return n}return null},getCompletion=async e=>{d(null),c(!0);let s=null;try{s=await createSession(),p(s),await connectWebSocket(s);let t={text:e,sender:"user",sessionId:s},n={text:"",sender:"bot",sessionId:s,status:"processing"};m(e=>[...e,t,n]);let r="".concat(l,"/generate"),o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,history:chatHistory(u),session_id:s})});if(!o.ok)throw Error("Generate request failed");let c=await o.json();if(c.status){let e=getLastMessage(c.data.messages);m(t=>t.map(t=>t.sessionId===s&&"bot"===t.sender?{...t,finalResponse:e,status:"complete"}:t))}else a.ZP.error(c.message)}catch(e){console.error("Error:",e),a.ZP.error("Error during request processing"),s&&b[s]&&b[s].close(),d({status:!1,message:e instanceof Error?e.message:"Unknown error occurred"})}finally{c(!1)}};return(0,n.jsxs)("div",{style:{height:"calc(100% - 20px)"},className:"text-primary overflow-auto bg-primary relative scroll rounded flex-1",children:[(0,n.jsx)(MessageList,{messages:u,sessionLogs:x,onRetry:getCompletion,loading:o}),(0,n.jsx)(ChatInput,{onSubmit:getCompletion,loading:o,error:i})]})}}},function(e){e.O(0,[731,971,472,744],function(){return e(e.s=38494)}),_N_E=e.O()}]);